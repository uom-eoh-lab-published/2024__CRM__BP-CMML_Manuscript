---
title: "Figure 01 - Panel A"
output: html_document
---

#Â 1. Setup

Defining work directory within rmarkdown chunk

```{r setup, include=TRUE}
local_wd_folder = dirname(dirname(dirname(rstudioapi::getSourceEditorContext()$path)))
knitr::opts_knit$set(root.dir = local_wd_folder)
```

Defining input data and output directories

```{r}
script_folder = dirname(rstudioapi::getSourceEditorContext()$path)
data_folder = './Data/Figure_01'
output_folder = './Figures/Figure_01'
```

## - Setting seed

This step ensures reproducibility in randomized processes

```{r}
set.seed(123)
```

## - Packages installation (optional)

```{r}
# Ensuring BiocManager is available for installation of Bioconductor packages
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")

# Defining a list of required packages used in this script
packages_required <- c("ComplexHeatmap", "stringr")

# Identifying if any of the required packages needs installing
packages_uninstalled <- packages_required[!(packages_required %in% installed.packages()[,"Package"])]

# Installing any uninstalled package identified above
if(length(packages_uninstalled)) BiocManager::install(packages_uninstalled)
```

## - Loading packages

```{r message=FALSE, warning=FALSE}
# Data import and utility functions
library(stringr, quietly = T)

# Visualization
library(ComplexHeatmap, quietly = T)
```

## - Loading palettes

```{r message=FALSE, warning=FALSE}
# Additional colour palettes
library(unikn, quietly = T)
library(RColorBrewer, quietly = T)
library(yarrr, quietly = T)
library(scales, quietly = T)
library(ggsci, quietly = T)

# A first set of custom color palettes from the unikn package
mix_1 <- usecol(pal = c(Karpfenblau, "white", Peach), n = 15)
mix_2 <- usecol(pal = c(rev(pal_seeblau), "white", pal_pinky))
mix_3 <- usecol(pal = c(rev(pal_bordeaux), "white", pal_petrol), n = 15)

seecol(list(mix_1, mix_2, mix_3),
       col_brd = "white", lwd_brd = 4, 
       title = "Comparing palettes mixed from unikn colors",
       pal_names = c("mix_1", "mix_2", "mix_3"))

# A second set of custom palettes from the RColorBrewer and yarrr packages
brew_mix <- usecol(c(rev(brewer.pal(n = 4, name = "Reds")), "white", brewer.pal(n = 4, name = "Blues")), n = 13)
brew_ext <- usecol(brewer.pal(n = 11, name = "Spectral"), n = 12)
yarrr_mix <- usecol(c(piratepal("nemo"), piratepal("bugs")))
yarrr_mod <- usecol(c(piratepal("ipod")), n = 9)

seecol(pal = list(brew_mix, brew_ext, yarrr_mix, yarrr_mod),
       col_brd = "white", lwd_brd = 2, 
       title = "Using usecol() and seecol() to mix and modify palettes",
       pal_names = c("brew_mix", "brew_ext", "yarrr_mix", "yarrr_mod"))

# Additional custom palettes from the scales package
natjournals_palette <- pal_npg("nrc")(10)
```

## - Log Session Info

```{r message=FALSE, warning=FALSE, class.source=}
writeLines(capture.output(sessionInfo()), paste(script_folder, '/Panel_A_SessionInfo', '.txt', sep = ''))

sessionInfo()
```

# 2. Loading input files

```{r}
Clinical_metadata <- read.csv(paste(data_folder, '/CHR_BP-CMML_clinical_metadata.csv', sep = ''), row.names = 'Patient.ID')

Mutation_metadata <- read.csv(paste(data_folder, '/CHR_BP-CMML_mutation_metadata.csv', sep = ''), row.names = 'Patient.ID')
```

# 3. Heatmap
## - Mutation matrix colors 

```{r}
# Loop over all columns in Mutation_metadata
for (colname in colnames(Mutation_metadata)) {
  # Convert the column to character
  Mutation_metadata[,colname] <- as.character(Mutation_metadata[,colname])
  # Replace '1' with 'MUT'
  Mutation_metadata[,colname] <- str_replace_all(Mutation_metadata[,colname], pattern = '1', replacement = 'MUT')
  # Replace '0' with ''
  Mutation_metadata[,colname] <- str_replace_all(Mutation_metadata[,colname], pattern = '0', replacement = '')
}

# Define a color mapping
col = c("MUT" = "grey25")

# Define a list of functions for drawing rectangles
alter_fun = list(
  # Function for drawing a light grey rectangle
  background = function(x, y, w, h) {
    grid.rect(x, y, w-unit(2, "pt"), h-unit(2, "pt"), 
              gp = gpar(fill = "grey93", col = NA))
  },
  # Function for drawing a rectangle with the color defined for 'MUT'
  MUT = function(x, y, w, h) {
    grid.rect(x, y, w-unit(2, "pt"), h-unit(2, "pt"), 
              gp = gpar(fill = col["MUT"], col = NA))
  }
)

# Define an empty column title
column_title = ""

# Define parameters for the heatmap legend
heatmap_legend_param = list(title = "Alternations", at = c("MUT"), 
                            labels = c("Mutation"))
```

## - Selecting relevant clinical metadata for visualisation

```{r}
# Subset Clinical_metadata to keep only certain columns
Clinical_metadata_selected <- Clinical_metadata[,c('Cutaneous.BPDCN', 
                                                   'ICC.classification',
                                                   'Cytogenetics.CPSS',
                                                   'Treatment.response',
                                                   'Upfront.HMA',
                                                   'Gender')]

# Subset Mutation_metadata to keep only the rows that have the same row names as Clinical_metadata_selected
Mutation_metadata <- Mutation_metadata[rownames(Clinical_metadata_selected),]
```

## - Defining categories and levels order

```{r}
# Convert 'Cutaneous.BPDCN' to a factor with levels 'No' and 'Yes'
Clinical_metadata_selected$Cutaneous.BPDCN <- factor(Clinical_metadata_selected$Cutaneous.BPDCN, 
                                                     levels = c('No', 'Yes'))

# Convert 'ICC.classification' to a factor with specific levels
Clinical_metadata_selected$ICC.classification <- factor(Clinical_metadata_selected$ICC.classification, 
                                                        levels = c('BPDCN',
                                                                   'AML not otherwise specified',
                                                                   'AML with CEBPA',
                                                                   'AML with NPM1',
                                                                   'AML with MDS-related gene mutations',
                                                                   'AML with MDS-related cytogenetic abnormalities'))

# Convert 'Cytogenetics.CPSS' to a factor with levels 'Low risk', 'Intermediate risk', and 'High risk'
Clinical_metadata_selected$Cytogenetics.CPSS <- factor(Clinical_metadata_selected$Cytogenetics.CPSS, 
                                                       levels = c('Low risk',
                                                                  'Intermediate risk',
                                                                  'High risk'))

# Convert 'Treatment.response' to a factor with levels 'CR', 'Refractory', and 'Not evaluable'
Clinical_metadata_selected$Treatment.response <- factor(Clinical_metadata_selected$Treatment.response, 
                                                        levels = c('CR',
                                                                   'Refractory',
                                                                   'Not evaluable'))

# Convert 'Upfront.HMA' to a factor with levels 'No' and 'Yes'
Clinical_metadata_selected$Upfront.HMA <- factor(Clinical_metadata_selected$Upfront.HMA, 
                                                 levels = c('No',
                                                            'Yes'))

# Convert 'Gender' to a factor with levels 'Female' and 'Male'
Clinical_metadata_selected$Gender <- factor(Clinical_metadata_selected$Gender, 
                                            levels = c('Female',
                                                       'Male'))

# Rename the columns of Clinical_metadata_selected
colnames(Clinical_metadata_selected) <- c('Cutaneous BPDCN', 
                                          'ICC classification', 
                                          'Cytogenetics (CPSS)',
                                          'Treatment response', 
                                          'Upfront HMA', 
                                          'Gender')
```

## - Heatmap columns metadata annotation colour

```{r}
# Define a list of color mappings for different categories in several variables
colors_top_annotation <-  list(
  `Cutaneous BPDCN` = c('Yes' = '#b5179e', 
                        'No' = '#ffd2fc'),
  `ICC classification` = c('BPDCN' = '#fff0f3',
                           'AML not otherwise specified' = '#ffccd5',
                           'AML with CEBPA' = '#ff8fa3',
                           'AML with NPM1' = '#ff4d6d',
                           'AML with MDS-related gene mutations' = '#c9184a',
                           'AML with MDS-related cytogenetic abnormalities' = '#800f2f'),
  `Cytogenetics (CPSS)` = c('Low risk' = '#ffdcc2',
                            'Intermediate risk' = '#eda268',
                            'High risk' = '#522500'),
  `Treatment response` = c('CR' = '#e9f5db',
                           'Refractory' = '#c2d5aa',
                           'Not evaluable' = '#606f49'),
  `Upfront HMA` = c('Yes' = '#72bbce', 
                    'No' = '#dceef3'),
  Gender = c('Male' = '#e1e5f2', 
             'Female' = '#bee3db')
)
```

## - Columns annotation

```{r}
# Create a heatmap annotation object
ha <- HeatmapAnnotation(
  df = Clinical_metadata_selected, 
  gp = gpar(lwd = 2, col = 'white'),
  col = colors_top_annotation, 
  show_annotation_name = TRUE, 
  annotation_name_side = "left",
  show_legend = TRUE,
  annotation_name_gp = gpar(fontsize = 12, fontfamily = 'sans', fontface = 'bold'), 
  annotation_legend_param = list(
    `Cutaneous BPDCN` = list(direction = "horizontal"),
    `ICC classification` = list(direction = "vertical"),
    `Cytogenetics (CPSS)` = list(direction = "vertical"),
    `Treatment response` = list(direction = "vertical"),
    `Upfront HMA` = list(direction = "horizontal"),
    `Gender` = list(direction = "horizontal")
  )
)
```

## - Heatmap styling

```{r}
# Set the padding for the column annotations to 0.4 cm
ht_opt$COLUMN_ANNO_PADDING = unit(0.4, "cm")

# Set the padding for the row annotations to 0.4 cm
ht_opt$ROW_ANNO_PADDING = unit(0.4, "cm")
```

## - Heatmap plotting

```{r}
# Create an oncoprint
oncoPrint_with_legend <- oncoPrint(t(Mutation_metadata),
                                   alter_fun = alter_fun, 
                                   alter_fun_is_vectorized = FALSE, 
                                   col = col, 
                                   remove_empty_columns = TRUE, 
                                   remove_empty_rows = TRUE,
                                   pct_side = "right", border = FALSE,
                                   row_names_side = "left",
                                   top_annotation = ha,
                                   pct_gp = gpar(fontsize = 12, fontfamily = 'sans'),
                                   row_names_gp = gpar(fontsize = 12, fontfamily = 'sans'),
                                   right_annotation =  rowAnnotation(rbar = anno_oncoprint_barplot()),
                                   left_annotation = NULL, show_heatmap_legend = TRUE,
                                   bottom_annotation =  columnAnnotation(botbar = anno_oncoprint_barplot(axis_param = list(direction = "reverse"))),
                                   column_title = column_title)

# Open a new PNG device for plotting
png(filename = paste(output_folder, '/CHR_BP-CMML_Patients__Oncoprint.png', sep = ''), units = 'cm', width = 35, height = 22, res = 300)

# Draw the oncoprint on the current plotting device
draw(oncoPrint_with_legend, heatmap_legend_side = "right", annotation_legend_side = "right")

# Add text to the "rbar" annotation
decorate_annotation("rbar", {
  grid.text("Number of\nmutations\nin cohort", x = unit(10, "mm"), y = unit(165, "mm"), rot = 0, just = "bottom")
})

# Add text to the "botbar" annotation
decorate_annotation("botbar", {
  grid.text("Number of\nmutations\nin patient", x = unit(-9, "mm"), y = unit(10, "mm"), rot = 90, just = "bottom")
})

# Close the current plotting device
dev.off()
```
