---
title: "Figure 02b - Panel C"
output: 
  rmdformats::robobook:
    lightbox: true
    fig_caption: true
---

<style type="text/css">
  body{
  font-size: 10pt;
}
</style>

# 1) Setup

## - Defining work directory

In this section, we define the working directory for the R Markdown document.

```{r setup, include=TRUE}
# Get the path of the current script
# Then get the parent directory of the parent directory of the parent directory
local_wd_folder <- dirname(dirname(dirname(rstudioapi::getSourceEditorContext()$path)))

# Set the root directory for knitr to the local working directory
knitr::opts_knit$set(root.dir = local_wd_folder)
```

## - Defining input data and output directories

Here, we define the directories for input data and output files.

```{r}
# Get the directory of the current script
script_folder <- dirname(rstudioapi::getSourceEditorContext()$path)

# Define the data folder and output folder
data_folder <- './Data'
#results_folder <- './Results'
figures_folder <- './Figures'
```

## - Setting seed

Setting a seed ensures that any random processes are reproducible.

```{r}
# Set a seed for reproducibility
set.seed(123)
```

## - Packages installation (optional)

In this section, we ensure that all necessary packages are installed.

```{r}
# Ensure BiocManager is available for installation of Bioconductor packages
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
#BiocManager::install(version = "3.18")

# Define a list of required packages used in this script
packages_required <- c("escape", "fgsea")

# Identify any required packages that are not installed
packages_uninstalled <- packages_required[!(packages_required %in% installed.packages()[,"Package"])]

# Install any uninstalled packages
if(length(packages_uninstalled)) BiocManager::install(packages_uninstalled)
```

## - Loading packages

Here, we load the necessary packages for our analysis.

```{r message=FALSE, warning=FALSE}
# Load stringr for string manipulation
library(escape, quietly = TRUE)
library(fgsea)
```

## - Log Session Info

Finally, we log the session information for reproducibility.

```{r message=TRUE, warning=TRUE}
# Write the session information to a text file
writeLines(capture.output(sessionInfo()), file.path(script_folder, 'Figure_02b_SessionInfo.txt'))

# Print the session information
sessionInfo()
```

# 2) Loading input files

```{r}
Expression_matrix <- read.csv(paste(data_folder, '/RNASeq/Counts/Processed_counts/Grouped/Tximport_TPM_mat.csv', 
                                    sep = ''), 
                              row.names = 'X')

colnames(Expression_matrix) <- str_replace_all(colnames(Expression_matrix), pattern = 'X', replacement = '')

Genes_annotation_metadata <- read.csv(paste(data_folder, "/RNASeq/Annotation_files/GENCODE_v42.gene_metadata.csv", sep = ''))
rownames(Genes_annotation_metadata) <- Genes_annotation_metadata$gene_id

Samples_metadata <- read.csv(paste(data_folder, '/RNASeq/Metadata/RNASeq_Samples_Metadata.csv', sep = ''), row.names = 'Patient.ID')
```

# 3) Ordering expression matrix (TPM)

```{r}
Unique_genes <- read.table(file = paste(data_folder, '/RNASeq/Counts/List_unique_genes.csv', 
                                    sep = ''), header = T, sep = ',')$unique_genes

Expression_matrix <- Expression_matrix[Unique_genes, ]

rownames(Expression_matrix) <- Genes_annotation_metadata[rownames(Expression_matrix),'gene_name']

Expression_matrix <- as.matrix(Expression_matrix)

Expression_matrix <- Expression_matrix[,rownames(Samples_metadata)]
```

# 4) Creating folders for Pathway Analyses

```{r}
dir.create(file.path(paste(data_folder, '/RNASeq/Pathway_Analysis/Control_vs_BP-CMML', 
                                    sep = '')), showWarnings = FALSE)
```

# 5) fGSEA Analyses 

## - Gene ranking

```{r}
Blast_phase_vs_Control_DEGS <- read.csv(paste(data_folder, '/RNASeq/DESeq2/DEGs_Comparisons/Control_vs_BP-CMML/DGE_BP-CMML_vs_Control_ALL_DEGs_LFC_Ashr.csv', sep = ''), row.names = 'X')

Blast_phase_vs_Control_DEGS$Rank <- sign(Blast_phase_vs_Control_DEGS$log2FoldChange)*(-1*log10(Blast_phase_vs_Control_DEGS$pvalue))

Blast_phase_vs_Control_DEGS <- Blast_phase_vs_Control_DEGS %>% arrange(-Rank)

Ranks <- Blast_phase_vs_Control_DEGS$Rank
names(Ranks) <- Blast_phase_vs_Control_DEGS$GeneSymbol
Ranks <- Ranks[grep(FALSE,is.na(Ranks))]
```

## - Hallmark analysis

```{r}
Hallmark_pathways_gmt_file <- paste(data_folder, '/RNASeq/Resources/Gene_Pathways/2022__GSEA_MSIGDB__h.all.v2022.1.Hs.symbols.gmt.txt', sep = '')
Hallmark_pathways <- gmtPathways(Hallmark_pathways_gmt_file)
str(head(Hallmark_pathways))

fgseaRes_Hallmark <- fgsea(pathways = Hallmark_pathways, 
                           stats = Ranks, 
                           minSize=10, 
                           maxSize = 500, 
                           nPermSimple = 10000)

fgseaRes_Hallmark <- fgseaRes_Hallmark %>% arrange(padj)
fgseaRes_Hallmark$leadingEdge <- NULL

write.csv(x = fgseaRes_Hallmark, file = paste(data_folder, '/RNASeq/Pathway_Analysis/Control_vs_BP-CMML/fGSEA_H_BP-CMML_vs_Control_all.csv', 
                                    sep = ''))

write.csv(x = fgseaRes_Hallmark %>% filter(NES > 0), file = paste(data_folder, '/RNASeq/Pathway_Analysis/Control_vs_BP-CMML/fGSEA_H_BP-CMML_vs_Control__Up_in_BP-CMML.csv', 
                                    sep = ''))

write.csv(x = fgseaRes_Hallmark %>% filter(NES < 0), file = paste(data_folder, '/RNASeq/Pathway_Analysis/Control_vs_BP-CMML/fGSEA_H_BP-CMML_vs_Control__Up_in_Control.csv', 
                                    sep = ''))
```

## - Canonical pathway analysis

```{r}
CanonicalPathways_gmt_file <- paste(data_folder, '/RNASeq/Resources/Gene_Pathways/2022__GSEA_MSIGDB__c2.cp.v2022.1.Hs.symbols.gmt.txt', sep = '')
CanonicalPathways <- gmtPathways(CanonicalPathways_gmt_file)
str(head(CanonicalPathways))

fgseaRes_CP <- fgsea(pathways = CanonicalPathways, 
                     stats = Ranks, 
                     minSize=10, 
                     maxSize = 500, 
                     nPermSimple = 10000)

fgseaRes_CP <- fgseaRes_CP %>% arrange(padj)
fgseaRes_CP$leadingEdge <- NULL

write.csv(x = fgseaRes_CP, file = paste(data_folder, '/RNASeq/Pathway_Analysis/Control_vs_BP-CMML/fGSEA_CP_BP-CMML_vs_Control_all.csv', 
                                    sep = ''))

write.csv(x = fgseaRes_CP %>% filter(NES > 0), file = paste(data_folder, '/RNASeq/Pathway_Analysis/Control_vs_BP-CMML/fGSEA_CP_BP-CMML_vs_Control__Up_in_BP-CMML.csv', 
                                    sep = ''))

write.csv(x = fgseaRes_CP %>% filter(NES < 0), file = paste(data_folder, '/RNASeq/Pathway_Analysis/Control_vs_BP-CMML/fGSEA_CP_BP-CMML_vs_Control__Up_in_Control.csv', 
                                    sep = ''))
```

## - GO BP pathway analysis

```{r}
GO_BP_gmt_file <- paste(data_folder, 
                        '/RNASeq/Resources/Gene_Pathways/2022__GSEA_MSIGDB__c5.go.bp.v2022.1.Hs.symbols.gmt.txt', sep = '')
GOBP_pathways <- gmtPathways(GO_BP_gmt_file)
str(head(GOBP_pathways))

fgseaRes_GO_BP <- fgsea(pathways = GOBP_pathways, 
                        stats = Ranks, 
                        minSize=10, 
                        maxSize = 500, 
                        nPermSimple = 10000)

fgseaRes_GO_BP <- fgseaRes_GO_BP %>% arrange(padj)
fgseaRes_GO_BP$leadingEdge <- NULL

write.csv(x = fgseaRes_GO_BP, file = paste(data_folder, '/RNASeq/Pathway_Analysis/Control_vs_BP-CMML/fGSEA_GO_BP_BP-CMML_vs_Control_all.csv', 
                                    sep = ''))

write.csv(x = fgseaRes_GO_BP %>% filter(NES > 0), file = paste(data_folder, '/RNASeq/Pathway_Analysis/Control_vs_BP-CMML/fGSEA_GO_BP_BP-CMML_vs_Control__Up_in_BP-CMML.csv', 
                                    sep = ''))

write.csv(x = fgseaRes_GO_BP %>% filter(NES < 0), file = paste(data_folder, '/RNASeq/Pathway_Analysis/Control_vs_BP-CMML/fGSEA_GO_BP_BP-CMML_vs_Control__Up_in_Control.csv', 
                                    sep = ''))
```

## - Pathway plotting

```{r}
Cumulative_fGSEAres <- rbind(fgseaRes_CP, fgseaRes_Hallmark, fgseaRes_GO_BP)
Cumulative_fGSEAres <- Cumulative_fGSEAres %>% arrange(padj)
Cumulative_fGSEAres_posNES <- Cumulative_fGSEAres %>% filter(NES > 0)
Cumulative_fGSEAres_posNES <- Cumulative_fGSEAres_posNES %>% 
  filter(pathway %in% c('HALLMARK_TNFA_SIGNALING_VIA_NFKB',
                        'REACTOME_NEUTROPHIL_DEGRANULATION',
                        'REACTOME_COMPLEMENT_CASCADE',
                        'GOBP_IMMUNE_RESPONSE_REGULATING_SIGNALING_PATHWAY',
                        'HALLMARK_INFLAMMATORY_RESPONSE',
                        'HALLMARK_IL6_JAK_STAT3_SIGNALING',
                        'HALLMARK_IL2_STAT5_SIGNALING',
                        'PID_AP1_PATHWAY'))

Cumulative_fGSEAres_negNES <- Cumulative_fGSEAres %>% filter(NES < 0)
Cumulative_fGSEAres_negNES <- Cumulative_fGSEAres_negNES %>% 
  filter(pathway %in% c('HALLMARK_E2F_TARGETS',
                        'PID_MYC_ACTIV_PATHWAY',
                        'HALLMARK_MYC_TARGETS_V1',
                        'HALLMARK_MYC_TARGETS_V2',
                        'GOBP_DNA_REPLICATION',
                        'REACTOME_CELL_CYCLE_CHECKPOINTS',
                        'HALLMARK_G2M_CHECKPOINT',
                        'REACTOME_S_PHASE'))

Cumulative_fGSEAres_top10 <- rbind(Cumulative_fGSEAres_posNES, Cumulative_fGSEAres_negNES)
Cumulative_fGSEAres_top10[1:8,'Cluster'] <- 'Blast phase'
Cumulative_fGSEAres_top10[9:16,'Cluster'] <- 'Control'

Cumulative_fGSEAres_top10$pathway <- c('TNFA signaling via NFKB',
                                       'Neutrophil degranulation',
                                       "Complement cascade",
                                       'Immune response signaling',
                                       'Inflammatory response',
                                       'IL6/JAK2/STAT3 signaling',
                                       'IL2/STAT5 signaling',
                                       'AP1 pathway',
                                       'E2F targets',
                                       'MYC activation',
                                       'MYC targets V1',
                                       'MYC targets V2',
                                       'DNA replication',
                                       'Cell cycle checkpoints',
                                       'G2M checkpoint',
                                       'S phase')

png(filename = paste(figures_folder, '/Figure_02/Panel_G.png', sep = ''),
    res = 300, units = 'cm', height = 10.34, width  = 11.5)

ggplot(Cumulative_fGSEAres_top10, aes(reorder(pathway, NES), NES)) +
  geom_col(aes(fill=Cluster)) +
  coord_flip() +
  labs(x="", y="Normalized Enrichment\nScore (NES)",
       title="") + 
  theme_minimal(base_line_size = 0.3) + 
  scale_fill_manual(values = c('Blast phase'    = '#DD3429',
                               'Control'    = '#A4BECE')) +
  theme(legend.position = 'none',
        plot.title = element_text(face='bold', size =14, family = 'sans'),
        axis.title.y = element_text(size =12, family = 'sans'),
        axis.title.x = element_text(size =12, family = 'sans'))

dev.off()
```

## - Enrichment plots selected signatures

```{r}
Quiescence_HSC_gmt_file <- paste(data_folder, 
                        '/RNASeq/Resources/Gene_Pathways/2007__Graham_et_al__NormalQuiescent_vs_NormalDividing.gmt', 
                        sep = '')

Quiescence_HSC_pathways <- gmtPathways(Quiescence_HSC_gmt_file)
str(head(Quiescence_HSC_pathways))

fgseaRes_Quiescence_HSC_pathways <- fgsea(pathways = Quiescence_HSC_pathways, 
                           stats = Ranks, 
                           minSize=10, 
                           maxSize = 500, 
                           nPermSimple = 10000)

png(filename = paste(figures_folder, '/Figure_02/Panel_H_01.png', sep = ''),
    res = 300, units = 'px', height = 670, width  = 1086)

plotEnrichment(Quiescence_HSC_pathways[[head(fgseaRes_Quiescence_HSC_pathways[order(pval), ], 1)$pathway]],
               Ranks) + labs(title=head(fgseaRes_Quiescence_HSC_pathways[order(pval), ], 1)$pathway) + 
  ggtitle('UP in quiescence vs dividing HSC\nGraham et al. 2007') + 
  theme(plot.title = element_text(hjust = 0.5, face = 'bold', size = 13, family='sans')) +
  ylab('Enrichment score') + xlab('Rank')

dev.off()

###

Roy2021_signatures <- read.csv(paste(data_folder, 
                        '/RNASeq/Resources/Gene_Pathways/2021__Roy_et_al__cellcycle.csv', 
                        sep = ''))

Roy2021_signatures <- as.list(Roy2021_signatures)
Roy2021_signatures$G2M <- unique(Roy2021_signatures$G2M)[1:length(unique(Roy2021_signatures$G2M))-1]
Roy2021_signatures$S_Phase <- unique(Roy2021_signatures$S_Phase)[1:length(unique(Roy2021_signatures$S_Phase))-1]

Roy2021_signatures_results <- fgsea(pathways = Roy2021_signatures, 
                           stats = Ranks, 
                           minSize=10, 
                           maxSize = 500, 
                           nPermSimple = 10000)

png(filename = paste(figures_folder, '/Figure_02/Panel_H_02.png', sep = ''),
    res = 300, units = 'px', height = 670, width  = 1086)

plotEnrichment(Roy2021_signatures[[head(Roy2021_signatures_results[order(pval), ], 1)$pathway]],
               Ranks) + labs(title=head(Roy2021_signatures_results[order(pval), ], 1)$pathway) + 
  ggtitle('G2M phase\nTirosh et al. 2016') + 
  theme(plot.title = element_text(hjust = 0.5, face = 'bold', size = 13, family='sans')) +
  ylab('Enrichment score') + xlab('Rank')

dev.off()

png(filename = paste(figures_folder, '/Figure_02/Panel_H_03.png', sep = ''),
    res = 300, units = 'px', height = 670, width  = 1086)

plotEnrichment(Roy2021_signatures[[Roy2021_signatures_results[3,'pathway'][[1]]]],
               Ranks) + labs(title='') + 
  ggtitle('S phase\nTirosh et al. 2016') + 
  theme(plot.title = element_text(hjust = 0.5, face = 'bold', size = 13, family='sans')) +
  ylab('Enrichment score') + xlab('Rank')

dev.off()

png(filename = paste(figures_folder, '/Figure_02/Panel_H_04.png', sep = ''),
    res = 300, units = 'px', height = 670, width  = 1086)

plotEnrichment(Roy2021_signatures[[Roy2021_signatures_results[2,'pathway'][[1]]]],
               Ranks) + labs(title='') + 
  ggtitle('Quiescence\nGiustacchini et al. 2017') + 
  theme(plot.title = element_text(hjust = 0.5, face = 'bold', size = 13, family='sans')) +
  ylab('Enrichment score') + xlab('Rank')

dev.off()

###

Senescence_gmt_file <- paste(data_folder, 
                        '/RNASeq/Resources/Gene_Pathways/2008__Fridman_and_Tainsky__UP_in_Senescencent.gmt', 
                        sep = '')

Senescence_pathways <- gmtPathways(Senescence_gmt_file)
str(head(Senescence_pathways))

fgseaRes_Senescence_pathways <- fgsea(pathways = Senescence_pathways, 
                           stats = Ranks, 
                           minSize=10, 
                           maxSize = 500, 
                           nPermSimple = 10000)

png(filename = paste(figures_folder, '/Figure_02/Panel_H_05.png', sep = ''),
    res = 300, units = 'px', height = 670, width  = 1086)

plotEnrichment(Senescence_pathways[[head(fgseaRes_Senescence_pathways[order(pval), ], 1)$pathway]],
               Ranks) + labs(title=head(fgseaRes_Senescence_pathways[order(pval), ], 1)$pathway) + 
  ggtitle('Senescence UP\nFridman and Tainsky 2008') + 
  theme(plot.title = element_text(hjust = 0.5, face = 'bold', size = 13, family='sans')) +
  ylab('Enrichment score') + xlab('Rank')

dev.off()
```